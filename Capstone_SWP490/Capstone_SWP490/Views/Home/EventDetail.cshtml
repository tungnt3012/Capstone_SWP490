@{
    ViewBag.Title = "Event | Detail";
    var events = ViewData["Events"] as Capstone_SWP490.Models.events_ViewModel.eventsViewModel;
    var subEvents = ViewData["SubEvents"] as List<Capstone_SWP490.Models.events_ViewModel.eventsViewModel>;
    var member = ViewData["Members"] as Capstone_SWP490.member;
    var profile = Session["profile"] as Capstone_SWP490.Models.app_userViewModel.app_userViewModel;
}
<style>
    #menu_Schedule {
        color: #ffffff !important;
        background: #30cf6b;
    }

    .venue-table {
        width: 135px;
    }

    .date-table {
        width: 135px;
    }

    .action-table {
        width: 70px;
    }

    .join-event {
        width: 100px;
    }
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

<div class="container-fluid xyz">
    <div class="col-lg-12" id="content_area2_header">
        <div class="col-lg-12" id="content_area2_title">
            <label for="exampleInputTitle">Event Detail</label>
        </div>
    </div>
    <div class="main">
        <div class="row">
            <div class="col-lg-10 col-lg-offset-1" id="under">
                @if (events != null)
                {
                    <section>
                        <div class="form-group" style="padding-left:15px">
                            <ul class="nav nav-tabs" id="myTab" role="tablist">
                                <li role="presentation" class="nav-item active">
                                    <a href="#step1" class="nav-link front-size-title active" data-toggle="tab" aria-controls="step1" role="tab" title="Step 1">About the Event</a>
                                </li>

                                <li role="presentation" class="nav-item">
                                    <a href="#step2" class="nav-link front-size-title" data-toggle="tab" aria-controls="step2" role="tab" title="Step 2">Description</a>
                                </li>
                                <li role="presentation" class="nav-item">
                                    <a href="#step3" class="nav-link front-size-title" data-toggle="tab" aria-controls="step3" role="tab" title="Step 3">Contact</a>
                                </li>

                            </ul>
                        </div>
                        <form role="form">
                            <div class="tab-content">

                                <div class="tab-pane active" role="tabpanel" id="step1">
                                    <div class="col-lg-12">
                                        <label class="border border-danger" for="Event_Schedule">
                                            Title:
                                        </label>
                                        <label class="border border-danger" for="Event_Schedule" style="font-weight: normal">
                                            @events.title
                                        </label>
                                    </div>
                                    <div class="col-lg-12">
                                        <label class="border border-danger" for="Event_Schedule">
                                            Time start:
                                        </label>
                                        <label class="border border-danger" for="Event_Schedule" style="font-weight: normal">
                                            @events.start_date_str.Split(',')[0]
                                        </label>
                                    </div>
                                    <div class="col-lg-12">
                                        <label class="border border-danger" for="Event_Schedule">
                                            Time end:
                                        </label>
                                        <label class="border border-danger" for="Event_Schedule" style="font-weight: normal">
                                            @events.end_date_str.Split(',')[0]
                                        </label>
                                    </div>
                                </div>

                                <div class="tab-pane" role="tabpanel" id="step2">
                                    <div class="col-lg-12">
                                        <label class="border border-danger" for="Event_Schedule">
                                            Description:
                                        </label>
                                        <label class="border border-danger" for="Event_Schedule" style="font-weight: normal">
                                            @events.desctiption
                                        </label>
                                    </div>
                                    <div class="col-lg-12">
                                        <label class="border border-danger" for="Event_Schedule">
                                            Location:
                                        </label>
                                        <label class="border border-danger" for="Event_Schedule" style="font-weight: normal">
                                            @events.venue
                                        </label>
                                    </div>
                                </div>
                                <div class="tab-pane" role="tabpanel" id="step3">
                                    <div class="col-lg-12">
                                        <label class="border border-danger" for="Event_Schedule">
                                            Contactor phone:
                                        </label>
                                        <label class="border border-danger" for="Event_Schedule" style="font-weight: normal">
                                            @events.contactor_phone
                                        </label>
                                    </div>
                                    <div class="col-lg-12">
                                        <label class="Event-Title" for="Event_Schedule">
                                            Contactor email:
                                        </label>
                                        <label class="Event-Content" for="Event_Schedule" style="font-weight: normal">
                                            @events.contactor_email
                                        </label>
                                    </div>
                                    <div class="col-lg-12">
                                        <label class="Event-Title" for="Event_Schedule">
                                            Contactor name:
                                        </label>
                                        <label class="Event-Content" for="Event_Schedule" style="font-weight: normal">
                                            @events.contactor_name
                                        </label>
                                    </div>
                                    <div class="col-lg-12">
                                        <label class="Event-Title" for="Event_Schedule">
                                            Fanpage:
                                        </label>
                                        <label class="Event-Content" for="Event_Schedule" style="font-weight: normal">
                                            <a href="#">@events.fan_page</a>
                                        </label>
                                    </div>
                                </div>
                                <div class="clearfix"></div>
                            </div>
                        </form>
                    </section>
                    if (Session["username"] != null)
                    {
                        if (profile.user_role.Equals("ORGANIZER"))
                        {
                            <div class="col-lg-12">
                                <button type="button" id="btn-add-event" onclick="window.location.href = '/Home/SubEventUpload?id=@events.event_id'" class="btn btn-success">Add Sub Event</button>
                            </div>
                        }
                    }
                    <div class="col-lg-12" id="under">
                        <table class="table table-striped table-bordered table-sm">
                            <thead>
                                <tr>
                                    <th scope="col">Title</th>
                                    <th scope="col">Time</th>
                                    <th scope="col" width="30%">Location</th>
                                    @if (Session["username"] != null)
                                    {
                                        if (profile.user_role.Equals("ORGANIZER"))
                                        {
                                            <th scope="col" width="2%"></th>
                                            <th scope="col" width="2%"></th>
                                            <th scope="col" width="2%"></th>
                                        }
                                    }
                                </tr>
                            </thead>
                            <tbody id="table-events">
                                @if (subEvents != null && subEvents.Count > 0)
                                {
                                    foreach (var x in subEvents)
                                    {
                                        <tr>
                                            @if (x.status == 1)
                                            {
                                                <td class="title-table" style="color: #9e0505 "><strong>@x.title</strong></td>
                                            }
                                            else if (x.status == 2)
                                            {
                                                <td class="title-table" style="color: blue "><strong>@x.title</strong></td>
                                            }
                                            else if (x.status == 3)
                                            {
                                                <td class="title-table" style="color: blue; background-color: #ffec19 "><strong>@x.title</strong></td>
                                            }
                                            else
                                            {
                                                <td class="title-table">@x.title</td>
                                            }
                                            <td class="date-table">@x.start_date.ToString("HH:mm") - @x.end_date.ToString("HH:mm")</td>
                                            <td class="venue-table">@x.venue</td>
                                            <td class="action-table">
                                                <a href="/Home/SubEventDetail?id=@x.event_id">
                                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-text-fill" viewBox="0 0 16 16">
                                                        <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0zM9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1zM4.5 9a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1h-7zM4 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5zm.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1h-4z" />
                                                    </svg>
                                                </a>
                                            </td>

                                            @if (Session["username"] != null)
                                            {
                                                if (profile.user_role.Equals("ORGANIZER"))
                                                {
                                                    <td class="action-table">
                                                        <a href="/Home/SubEventEdit?id=@x.event_id&mainEid=@events.event_id">
                                                            <svg xmlns="http://www.w3.org/2000/svg" style="color:green" width="16" height="16" fill="currentColor" class="bi bi-pencil-square" viewBox="0 0 16 16">
                                                                <path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.21a.5.5 0 0 0-.121.196l-.805 2.414a.25.25 0 0 0 .316.316l2.414-.805a.5.5 0 0 0 .196-.12l6.813-6.814z" />
                                                                <path fill-rule="evenodd" d="M1 13.5A1.5 1.5 0 0 0 2.5 15h11a1.5 1.5 0 0 0 1.5-1.5v-6a.5.5 0 0 0-1 0v6a.5.5 0 0 1-.5.5h-11a.5.5 0 0 1-.5-.5v-11a.5.5 0 0 1 .5-.5H9a.5.5 0 0 0 0-1H2.5A1.5 1.5 0 0 0 1 2.5v11z" />
                                                            </svg>
                                                        </a>
                                                    </td>
                                                    @*<td class="action-table"><a href="/Home/SubEventDetail?id=@x.event_id">Detail</a></td>*@
                                                    <td class="action-table">
                                                        <a href="/Home/EventDelete?id=@x.event_id">
                                                            <svg xmlns="http://www.w3.org/2000/svg" style="color:red" width="16" height="16" fill="currentColor" class="bi bi-trash-fill" viewBox="0 0 16 16">
                                                                <path d="M2.5 1a1 1 0 0 0-1 1v1a1 1 0 0 0 1 1H3v9a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V4h.5a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H10a1 1 0 0 0-1-1H7a1 1 0 0 0-1 1H2.5zm3 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 .5-.5zM8 5a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 5zm3 .5v7a.5.5 0 0 1-1 0v-7a.5.5 0 0 1 1 0z" />
                                                            </svg>
                                                        </a>
                                                    </td>
                                                }
                                                else if ((((profile.user_role.Equals("COACH")) || (profile.user_role.Equals("MEMBER"))) && x.status != -1))
                                                {
                                                    @*
                                                        Event cho phep Join hay khong
                                                    *@
                                                    if (((profile.user_role.Equals("MEMBER")) && x.status == 1)
                                                    || ((profile.user_role.Equals("COACH")) && x.status == 2)
                                                    || (((profile.user_role.Equals("COACH")) || (profile.user_role.Equals("MEMBER"))) && x.status == 3))
                                                    {
                                                        if (x.is_user_joined)
                                                        {
                                                            @*<input type="hidden" id="date" value="@(x.start_date)">
                                                                <input type="hidden" id="date0" value="@(DateTime.Now)">
                                                                <input type="hidden" id="date1" value="@((x.start_date-DateTime.Now).TotalHours)">*@
                                                            if ((x.start_date - DateTime.Now).TotalHours > 3)
                                                            {
                                                                <td class="join-event">
                                                                    <button class="btn-sm btn-secondary" id="btn-unjoin" sub-event-id="@x.event_id" onclick="UnJoinSubEvent(this)">
                                                                        UnJoined
                                                                    </button>
                                                                </td>
                                                            }
                                                            else
                                                            {
                                                                <td class="join-event">
                                                                    <button class="btn-sm btn-secondary" disabled>
                                                                        Joined
                                                                    </button>
                                                                </td>
                                                            }
                                                        }
                                                        else
                                                        {
                                                            if ((x.start_date - DateTime.Now).TotalHours > 3)
                                                            {
                                                                <td class="join-event">
                                                                    <button class="btn-sm btn-success" sub-event-id="@x.event_id" onclick="JoinSubEvent(this)">
                                                                        Join Now
                                                                    </button>
                                                                </td>
                                                            }
                                                            else
                                                            {
                                                                <td class="join-event">
                                                                    <button class="btn-sm btn-secondary" disabled>
                                                                        Close
                                                                    </button>
                                                                </td>
                                                            }

                                                        }
                                                    }
                                                    else
                                                    {
                                                        <td class="join-event">
                                                            @*<button class="btn-sm btn-success" sub-event-id="@x.event_id" onclick="JoinSubEvent(this)">
                                                                    Join Now
                                                                </button>*@
                                                        </td>
                                                    }
                                                }
                                            }
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td><i>No Sub event</i></td></tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="col-lg-12">
                        <button type="button" id="btn-cancel-event" onclick="window.location.href = '/Home/Event'" class="btn btn-secondary">Back</button>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<input type="hidden" id="userss" value="@Session["username"]">
@if (Session["username"] != null)
{
    <input type="hidden" id="user_role" value="@profile.user_role">
    <input type="hidden" id="user_id" value="@profile.user_id">
}
else
{
    <input type="hidden" id="user_role" value="0">
    <input type="hidden" id="user_id" value="0">
}

<script>

    function JoinEvent(e) {
        var x = $(e).attr("member-id");
        $.ajax({
            type: 'POST',
            url: '@Url.Action("JoinEvent", "Home")',
            data: JSON.stringify({ 'userId': x }),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (rs) {
                if (rs != null) {
                    var s = rs;
                    if (rs.Status == 1) {
                        alert("Join Event Successfully!!!");
                        location.reload();
                    } else {
                        alert("Fail");
                    }
                }
            }
        });
    }

    function JoinSubEvent(e) {
        var _subEventId = $(e).attr("sub-event-id");
        var _userId = $("#user_id").val();
        $.ajax({
            type: 'POST',
            url: '@Url.Action("JoinSubEvent", "Home")',
            data: JSON.stringify({ 'subEvent': _subEventId, 'userCrr': _userId }),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (rs) {
                if (rs != null) {
                    var s = rs;
                    if (rs.Status == 1) {
                        alert("Join Event Successfully!!!");
                        location.reload();
                    } else {
                        alert("Fail");
                    }
                }
            }
        });
    }

     function UnJoinSubEvent(e) {
        var _subEventId = $(e).attr("sub-event-id");
        var _userId = $("#user_id").val();
        $.ajax({
            type: 'POST',
            url: '@Url.Action("UnJoinSubEvent", "Home")',
            data: JSON.stringify({ 'subEvent': _subEventId, 'userCrr': _userId }),
            dataType: "json",
            contentType: "application/json; charset=utf-8",
            success: function (rs) {
                if (rs != null) {
                    var s = rs;
                    if (rs.Status == 1) {
                        alert("UnJoin Event Successfully!!!");
                        location.reload();
                    } else {
                        alert("Fail");
                    }
                }
            }
        });
    }

</script>
